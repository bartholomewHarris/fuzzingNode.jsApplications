/**
 * @license
 * Copyright Google LLC All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
(function (factory) {
    if (typeof module === "object" && typeof module.exports === "object") {
        var v = factory(require, exports);
        if (v !== undefined) module.exports = v;
    }
    else if (typeof define === "function" && define.amd) {
        define("@nguniversal/common/schematics/migrations/update-9/index", ["require", "exports", "@angular-devkit/core", "@angular-devkit/schematics", "@angular-devkit/schematics/tasks", "@schematics/angular/utility/ast-utils", "@schematics/angular/utility/dependencies", "@schematics/angular/utility/workspace", "@schematics/angular/utility/workspace-models", "typescript"], factory);
    }
})(function (require, exports) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    exports.version9UpdateRule = void 0;
    const core_1 = require("@angular-devkit/core");
    const schematics_1 = require("@angular-devkit/schematics");
    const tasks_1 = require("@angular-devkit/schematics/tasks");
    const ast_utils_1 = require("@schematics/angular/utility/ast-utils");
    const dependencies_1 = require("@schematics/angular/utility/dependencies");
    const workspace_1 = require("@schematics/angular/utility/workspace");
    const workspace_models_1 = require("@schematics/angular/utility/workspace-models");
    const ts = require("typescript");
    function version9UpdateRule(collectionPath) {
        return (host) => __awaiter(this, void 0, void 0, function* () {
            return schematics_1.chain([
                backupPackageScriptsRule(),
                updateProjectsStructureRule(collectionPath),
                (tree, context) => {
                    const packageChanges = tree.actions.some(a => a.path.endsWith('/package.json'));
                    if (context && packageChanges) {
                        context.addTask(new tasks_1.NodePackageInstallTask());
                    }
                },
            ]);
        });
    }
    exports.version9UpdateRule = version9UpdateRule;
    function backupPackageScriptsRule() {
        return tree => {
            // Remove old scripts in 'package.json'
            const pkgPath = '/package.json';
            const buffer = tree.read(pkgPath);
            if (!buffer) {
                throw new schematics_1.SchematicsException('Could not find package.json');
            }
            const pkg = JSON.parse(buffer.toString());
            const scripts = pkg.scripts;
            if (!scripts) {
                return;
            }
            // Backup script targets
            [
                'compile:server',
                'build:ssr',
                'serve:ssr',
                'build:client-and-server-bundles',
            ].forEach(key => {
                const keyBackup = `${key}_bak`;
                const scriptValue = scripts[key];
                // Check if script target exists and it has not been already backed up
                if (scriptValue && !scripts[keyBackup]) {
                    scripts[keyBackup] = scriptValue;
                    scripts[key] = undefined;
                }
            });
            tree.overwrite(pkgPath, JSON.stringify(pkg, null, 2));
        };
    }
    function updateProjectsStructureRule(collectionPath) {
        return (tree) => __awaiter(this, void 0, void 0, function* () {
            const workspace = yield workspace_1.getWorkspace(tree);
            const installRules = [];
            for (const [projectName, projectDefinition] of workspace.projects) {
                const serverTarget = projectDefinition.targets.get('server');
                if (!serverTarget || serverTarget.builder !== workspace_models_1.Builders.Server) {
                    // Only process those targets which have a known builder for the CLI
                    continue;
                }
                const root = core_1.normalize(projectDefinition.root);
                // Backup old files
                [
                    'server.ts',
                    'webpack.server.config.js',
                ]
                    .map(f => core_1.join(root, f))
                    .filter(f => tree.exists(f))
                    .forEach(f => tree.rename(f, `${f}.bak`));
                const installOptions = {
                    clientProject: projectName,
                    // Skip install, so we only do one for the entire workspace at the end.
                    skipInstall: true,
                };
                // Run the install schematic again so that we re-create the entire stucture.
                installRules.push(removeModuleMapNgfactoryLoaderRule(core_1.normalize(projectDefinition.sourceRoot)), collectionPath
                    ? schematics_1.externalSchematic(collectionPath, 'ng-add', installOptions)
                    : schematics_1.noop());
            }
            return schematics_1.chain(installRules);
        });
    }
    function removeModuleMapNgfactoryLoaderRule(sourceRoot) {
        return tree => {
            const moduleMapLoaderPackageName = '@nguniversal/module-map-ngfactory-loader';
            // Strip BOM as otherwise TSC methods (Ex: getWidth) will return an offset which
            // which breaks the CLI UpdateRecorder.
            // See: https://github.com/angular/angular/pull/30719
            const createSourceFile = (path) => ts.createSourceFile(path, tree.read(path).toString().replace(/^\uFEFF/, ''), ts.ScriptTarget.Latest, true);
            // Update main.server file
            const mainServerPath = core_1.join(sourceRoot, 'main.server.ts');
            if (tree.exists(mainServerPath)) {
                const recorder = tree.beginUpdate(mainServerPath);
                // Remove exports of '@nguniversal/module-map-ngfactory-loader'
                createSourceFile(mainServerPath)
                    .statements
                    .filter(s => (ts.isExportDeclaration(s) &&
                    s.moduleSpecifier &&
                    ts.isStringLiteral(s.moduleSpecifier) &&
                    s.moduleSpecifier.text === moduleMapLoaderPackageName))
                    .forEach(node => {
                    const index = node.getFullStart();
                    const length = node.getFullWidth();
                    recorder.remove(index, length);
                });
                tree.commitUpdate(recorder);
            }
            // Update app.server.module file
            const appServerModule = core_1.join(sourceRoot, 'app/app.server.module.ts');
            if (tree.exists(appServerModule)) {
                const recorder = tree.beginUpdate(appServerModule);
                const appServerSourceFile = createSourceFile(appServerModule);
                // Remove imports of '@nguniversal/module-map-ngfactory-loader'
                appServerSourceFile
                    .statements
                    .filter(s => (ts.isImportDeclaration(s) &&
                    s.moduleSpecifier &&
                    ts.isStringLiteral(s.moduleSpecifier) &&
                    s.moduleSpecifier.text === moduleMapLoaderPackageName))
                    .forEach(node => {
                    const index = node.getFullStart();
                    const length = node.getFullWidth();
                    recorder.remove(index, length);
                });
                // Create a TS printer to get the text
                const printer = ts.createPrinter();
                // Remove 'ModuleMapLoaderModule' from 'NgModule' imports
                ast_utils_1.getDecoratorMetadata(appServerSourceFile, 'NgModule', '@angular/core')
                    .forEach((metadata) => {
                    const matchingProperties = ast_utils_1.getMetadataField(metadata, 'imports');
                    if (!matchingProperties) {
                        return;
                    }
                    const assignment = matchingProperties[0];
                    if (!ts.isArrayLiteralExpression(assignment.initializer)) {
                        return;
                    }
                    const arrayLiteral = assignment.initializer;
                    const newImports = arrayLiteral.elements
                        .filter(n => !(ts.isIdentifier(n) && n.text === 'ModuleMapLoaderModule'));
                    if (arrayLiteral.elements.length !== newImports.length) {
                        const newImportsText = printer.printNode(ts.EmitHint.Unspecified, ts.updateArrayLiteral(arrayLiteral, newImports), appServerSourceFile);
                        const index = arrayLiteral.getStart();
                        const length = arrayLiteral.getWidth();
                        recorder
                            .remove(index, length)
                            .insertLeft(index, newImportsText);
                    }
                });
                tree.commitUpdate(recorder);
            }
            // Remove package dependency
            dependencies_1.removePackageJsonDependency(tree, moduleMapLoaderPackageName);
        };
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9tb2R1bGVzL2NvbW1vbi9zY2hlbWF0aWNzL21pZ3JhdGlvbnMvdXBkYXRlLTkvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztHQU1HOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0lBRUgsK0NBQTZEO0lBQzdELDJEQU1vQztJQUNwQyw0REFBMEU7SUFFMUUscUVBQStGO0lBQy9GLDJFQUF1RjtJQUN2RixxRUFBcUU7SUFDckUsbUZBQXdFO0lBQ3hFLGlDQUFpQztJQUVqQyxTQUFnQixrQkFBa0IsQ0FBQyxjQUFzQjtRQUN2RCxPQUFPLENBQU0sSUFBSSxFQUFDLEVBQUU7WUFDbEIsT0FBTyxrQkFBSyxDQUFDO2dCQUNYLHdCQUF3QixFQUFFO2dCQUMxQiwyQkFBMkIsQ0FBQyxjQUFjLENBQUM7Z0JBQzNDLENBQUMsSUFBSSxFQUFFLE9BQU8sRUFBRSxFQUFFO29CQUNoQixNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUM7b0JBQ2hGLElBQUksT0FBTyxJQUFJLGNBQWMsRUFBRTt3QkFDN0IsT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLDhCQUFzQixFQUFFLENBQUMsQ0FBQztxQkFDL0M7Z0JBQ0gsQ0FBQzthQUNGLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQSxDQUFDO0lBQ0osQ0FBQztJQWJELGdEQWFDO0lBRUQsU0FBUyx3QkFBd0I7UUFDL0IsT0FBTyxJQUFJLENBQUMsRUFBRTtZQUNaLHVDQUF1QztZQUN2QyxNQUFNLE9BQU8sR0FBRyxlQUFlLENBQUM7WUFDaEMsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUNsQyxJ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LENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2FBQzdCO1lBRUQsNEJBQTRCO1lBQzVCLDBDQUEyQixDQUFDLElBQUksRUFBRSwwQkFBMEIsQ0FBQyxDQUFDO1FBQ2hFLENBQUMsQ0FBQztJQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgR29vZ2xlIExMQyBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGFuIE1JVC1zdHlsZSBsaWNlbnNlIHRoYXQgY2FuIGJlXG4gKiBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGF0IGh0dHBzOi8vYW5ndWxhci5pby9saWNlbnNlXG4gKi9cblxuaW1wb3J0IHsgUGF0aCwgam9pbiwgbm9ybWFsaXplIH0gZnJvbSAnQGFuZ3VsYXItZGV2a2l0L2NvcmUnO1xuaW1wb3J0IHtcbiAgUnVsZSxcbiAgU2NoZW1hdGljc0V4Y2VwdGlvbixcbiAgY2hhaW4sXG4gIGV4dGVybmFsU2NoZW1hdGljLFxuICBub29wLFxufSBmcm9tICdAYW5ndWxhci1kZXZraXQvc2NoZW1hdGljcyc7XG5pbXBvcnQgeyBOb2RlUGFja2FnZUluc3RhbGxUYXNrIH0gZnJvbSAnQGFuZ3VsYXItZGV2a2l0L3NjaGVtYXRpY3MvdGFza3MnO1xuaW1wb3J0IHsgU2NoZW1hIGFzIFVuaXZlcnNhbE9wdGlvbnMgfSBmcm9tICdAc2NoZW1hdGljcy9hbmd1bGFyL3VuaXZlcnNhbC9zY2hlbWEnO1xuaW1wb3J0IHsgZ2V0RGVjb3JhdG9yTWV0YWRhdGEsIGdldE1ldGFkYXRhRmllbGQgfSBmcm9tICdAc2NoZW1hdGljcy9hbmd1bGFyL3V0aWxpdHkvYXN0LXV0aWxzJztcbmltcG9ydCB7IHJlbW92ZVBhY2thZ2VKc29uRGVwZW5kZW5jeSB9IGZyb20gJ0BzY2hlbWF0aWNzL2FuZ3VsYXIvdXRpbGl0eS9kZXBlbmRlbmNpZXMnO1xuaW1wb3J0IHsgZ2V0V29ya3NwYWNlIH0gZnJvbSAnQHNjaGVtYXRpY3MvYW5ndWxhci91dGlsaXR5L3dvcmtzcGFjZSc7XG5pbXBvcnQgeyBCdWlsZGVycyB9IGZyb20gJ0BzY2hlbWF0aWNzL2FuZ3VsYXIvdXRpbGl0eS93b3Jrc3BhY2UtbW9kZWxzJztcbmltcG9ydCAqIGFzIHRzIGZyb20gJ3R5cGVzY3JpcHQnO1xuXG5leHBvcnQgZnVuY3Rpb24gdmVyc2lvbjlVcGRhdGVSdWxlKGNvbGxlY3Rpb25QYXRoOiBzdHJpbmcpOiBSdWxlIHtcbiAgcmV0dXJuIGFzeW5jIGhvc3QgPT4ge1xuICAgIHJldHVybiBjaGFpbihbXG4gICAgICBiYWNrdXBQYWNrYWdlU2NyaXB0c1J1bGUoKSxcbiAgICAgIHVwZGF0ZVByb2plY3RzU3RydWN0dXJlUnVsZShjb2xsZWN0aW9uUGF0aCksXG4gICAgICAodHJlZSwgY29udGV4dCkgPT4ge1xuICAgICAgICBjb25zdCBwYWNrYWdlQ2hhbmdlcyA9IHRyZWUuYWN0aW9ucy5zb21lKGEgPT4gYS5wYXRoLmVuZHNXaXRoKCcvcGFja2FnZS5qc29uJykpO1xuICAgICAgICBpZiAoY29udGV4dCAmJiBwYWNrYWdlQ2hhbmdlcykge1xuICAgICAgICAgIGNvbnRleHQuYWRkVGFzayhuZXcgTm9kZVBhY2thZ2VJbnN0YWxsVGFzaygpKTtcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICBdKTtcbiAgfTtcbn1cblxuZnVuY3Rpb24gYmFja3VwUGFja2FnZVNjcmlwdHNSdWxlKCk6IFJ1bGUge1xuICByZXR1cm4gdHJlZSA9PiB7XG4gICAgLy8gUmVtb3ZlIG9sZCBzY3JpcHRzIGluICdwYWNrYWdlLmpzb24nXG4gICAgY29uc3QgcGtnUGF0aCA9ICcvcGFja2FnZS5qc29uJztcbiAgICBjb25zdCBidWZmZXIgPSB0cmVlLnJlYWQocGtnUGF0aCk7XG4gICAgaWYgKCFidWZmZXIpIHtcbiAgICAgIHRocm93IG5ldyBTY2hlbWF0aWNzRXhjZXB0aW9uKCdDb3VsZCBub3QgZmluZCBwYWNrYWdlLmpzb24nKTtcbiAgICB9XG5cbiAgICBjb25zdCBwa2cgPSBKU09OLnBhcnNlKGJ1ZmZlci50b1N0cmluZygpKTtcbiAgICBjb25zdCBzY3JpcHRzID0gcGtnLnNjcmlwdHM7XG4gICAgaWYgKCFzY3JpcHRzKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gQmFja3VwIHNjcmlwdCB0YXJnZXRzXG4gICAgW1xuICAgICAgJ2NvbXBpbGU6c2VydmVyJyxcbiAgICAgICdidWlsZDpzc3InLFxuICAgICAgJ3NlcnZlOnNzcicsXG4gICAgICAnYnVpbGQ6Y2xpZW50LWFuZC1zZXJ2ZXItYnVuZGxlcycsXG4gICAgXS5mb3JFYWNoKGtleSA9PiB7XG4gICAgICBjb25zdCBrZXlCYWNrdXAgPSBgJHtrZXl9X2Jha2A7XG4gICAgICBjb25zdCBzY3JpcHRWYWx1ZSA9IHNjcmlwdHNba2V5XTtcbiAgICAgIC8vIENoZWNrIGlmIHNjcmlwdCB0YXJnZXQgZXhpc3RzIGFuZCBpdCBoYXMgbm90IGJlZW4gYWxyZWFkeSBiYWNrZWQgdXBcbiAgICAgIGlmIChzY3JpcHRWYWx1ZSAmJiAhc2NyaXB0c1trZXlCYWNrdXBdKSB7XG4gICAgICAgIHNjcmlwdHNba2V5QmFja3VwXSA9IHNjcmlwdFZhbHVlO1xuICAgICAgICBzY3JpcHRzW2tleV0gPSB1bmRlZmluZWQ7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICB0cmVlLm92ZXJ3cml0ZShwa2dQYXRoLCBKU09OLnN0cmluZ2lmeShwa2csIG51bGwsIDIpKTtcbiAgfTtcbn1cblxuZnVuY3Rpb24gdXBkYXRlUHJvamVjdHNTdHJ1Y3R1cmVSdWxlKGNvbGxlY3Rpb25QYXRoOiBzdHJpbmcpOiBSdWxlIHtcbiAgcmV0dXJuIGFzeW5jIHRyZWUgPT4ge1xuICAgIGNvbnN0IHdvcmtzcGFjZSA9IGF3YWl0IGdldFdvcmtzcGFjZSh0cmVlKTtcbiAgICBjb25zdCBpbnN0YWxsUnVsZXM6IFJ1bGVbXSA9IFtdO1xuXG4gICAgZm9yIChjb25zdCBbcHJvamVjdE5hbWUsIHByb2plY3REZWZpbml0aW9uXSBvZiB3b3Jrc3BhY2UucHJvamVjdHMpIHtcbiAgICAgIGNvbnN0IHNlcnZlclRhcmdldCA9IHByb2plY3REZWZpbml0aW9uLnRhcmdldHMuZ2V0KCdzZXJ2ZXInKTtcbiAgICAgIGlmICghc2VydmVyVGFyZ2V0IHx8IHNlcnZlclRhcmdldC5idWlsZGVyICE9PSBCdWlsZGVycy5TZXJ2ZXIpIHtcbiAgICAgICAgLy8gT25seSBwcm9jZXNzIHRob3NlIHRhcmdldHMgd2hpY2ggaGF2ZSBhIGtub3duIGJ1aWxkZXIgZm9yIHRoZSBDTElcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHJvb3QgPSBub3JtYWxpemUocHJvamVjdERlZmluaXRpb24ucm9vdCk7XG5cbiAgICAgIC8vIEJhY2t1cCBvbGQgZmlsZXNcbiAgICAgIFtcbiAgICAgICAgJ3NlcnZlci50cycsXG4gICAgICAgICd3ZWJwYWNrLnNlcnZlci5jb25maWcuanMnLFxuICAgICAgXVxuICAgICAgICAubWFwKGYgPT4gam9pbihyb290LCBmKSlcbiAgICAgICAgLmZpbHRlcihmID0+IHRyZWUuZXhpc3RzKGYpKVxuICAgICAgICAuZm9yRWFjaChmID0+IHRyZWUucmVuYW1lKGYsIGAke2Z9LmJha2ApKTtcblxuICAgICAgY29uc3QgaW5zdGFsbE9wdGlvbnM6IFVuaXZlcnNhbE9wdGlvbnMgPSB7XG4gICAgICAgIGNsaWVudFByb2plY3Q6IHByb2plY3ROYW1lLFxuICAgICAgICAvLyBTa2lwIGluc3RhbGwsIHNvIHdlIG9ubHkgZG8gb25lIGZvciB0aGUgZW50aXJlIHdvcmtzcGFjZSBhdCB0aGUgZW5kLlxuICAgICAgICBza2lwSW5zdGFsbDogdHJ1ZSxcbiAgICAgIH07XG5cbiAgICAgIC8vIFJ1biB0aGUgaW5zdGFsbCBzY2hlbWF0aWMgYWdhaW4gc28gdGhhdCB3ZSByZS1jcmVhdGUgdGhlIGVudGlyZSBzdHVjdHVyZS5cbiAgICAgIGluc3RhbGxSdWxlcy5wdXNoKFxuICAgICAgICByZW1vdmVNb2R1bGVNYXBOZ2ZhY3RvcnlMb2FkZXJSdWxlKG5vcm1hbGl6ZShwcm9qZWN0RGVmaW5pdGlvbi5zb3VyY2VSb290KSksXG4gICAgICAgIGNvbGxlY3Rpb25QYXRoXG4gICAgICAgICAgPyBleHRlcm5hbFNjaGVtYXRpYyhjb2xsZWN0aW9uUGF0aCwgJ25nLWFkZCcsIGluc3RhbGxPcHRpb25zKVxuICAgICAgICAgIDogbm9vcCgpLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gY2hhaW4oaW5zdGFsbFJ1bGVzKTtcbiAgfTtcbn1cblxuZnVuY3Rpb24gcmVtb3ZlTW9kdWxlTWFwTmdmYWN0b3J5TG9hZGVyUnVsZShzb3VyY2VSb290OiBQYXRoKTogUnVsZSB7XG4gIHJldHVybiB0cmVlID0+IHtcbiAgICBjb25zdCBtb2R1bGVNYXBMb2FkZXJQYWNrYWdlTmFtZSA9ICdAbmd1bml2ZXJzYWwvbW9kdWxlLW1hcC1uZ2ZhY3RvcnktbG9hZGVyJztcblxuICAgIC8vIFN0cmlwIEJPTSBhcyBvdGhlcndpc2UgVFNDIG1ldGhvZHMgKEV4OiBnZXRXaWR0aCkgd2lsbCByZXR1cm4gYW4gb2Zmc2V0IHdoaWNoXG4gICAgLy8gd2hpY2ggYnJlYWtzIHRoZSBDTEkgVXBkYXRlUmVjb3JkZXIuXG4gICAgLy8gU2VlOiBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9hbmd1bGFyL3B1bGwvMzA3MTlcbiAgICBjb25zdCBjcmVhdGVTb3VyY2VGaWxlID0gKHBhdGg6IHN0cmluZykgPT4gdHMuY3JlYXRlU291cmNlRmlsZShcbiAgICAgIHBhdGgsXG4gICAgICB0cmVlLnJlYWQocGF0aCkudG9TdHJpbmcoKS5yZXBsYWNlKC9eXFx1RkVGRi8sICcnKSxcbiAgICAgIHRzLlNjcmlwdFRhcmdldC5MYXRlc3QsXG4gICAgICB0cnVlLFxuICAgICk7XG5cbiAgICAvLyBVcGRhdGUgbWFpbi5zZXJ2ZXIgZmlsZVxuICAgIGNvbnN0IG1haW5TZXJ2ZXJQYXRoID0gam9pbihzb3VyY2VSb290LCAnbWFpbi5zZXJ2ZXIudHMnKTtcbiAgICBpZiAodHJlZS5leGlzdHMobWFpblNlcnZlclBhdGgpKSB7XG4gICAgICBjb25zdCByZWNvcmRlciA9IHRyZWUuYmVnaW5VcGRhdGUobWFpblNlcnZlclBhdGgpO1xuXG4gICAgICAvLyBSZW1vdmUgZXhwb3J0cyBvZiAnQG5ndW5pdmVyc2FsL21vZHVsZS1tYXAtbmdmYWN0b3J5LWxvYWRlcidcbiAgICAgIGNyZWF0ZVNvdXJjZUZpbGUobWFpblNlcnZlclBhdGgpXG4gICAgICAgIC5zdGF0ZW1lbnRzXG4gICAgICAgIC5maWx0ZXIocyA9PiAoXG4gICAgICAgICAgdHMuaXNFeHBvcnREZWNsYXJhdGlvbihzKSAmJlxuICAgICAgICAgIHMubW9kdWxlU3BlY2lmaWVyICYmXG4gICAgICAgICAgdHMuaXNTdHJpbmdMaXRlcmFsKHMubW9kdWxlU3BlY2lmaWVyKSAmJlxuICAgICAgICAgIHMubW9kdWxlU3BlY2lmaWVyLnRleHQgPT09IG1vZHVsZU1hcExvYWRlclBhY2thZ2VOYW1lXG4gICAgICAgICkpXG4gICAgICAgIC5mb3JFYWNoKG5vZGUgPT4ge1xuICAgICAgICAgIGNvbnN0IGluZGV4ID0gbm9kZS5nZXRGdWxsU3RhcnQoKTtcbiAgICAgICAgICBjb25zdCBsZW5ndGggPSBub2RlLmdldEZ1bGxXaWR0aCgpO1xuICAgICAgICAgIHJlY29yZGVyLnJlbW92ZShpbmRleCwgbGVuZ3RoKTtcbiAgICAgICAgfSk7XG4gICAgICB0cmVlLmNvbW1pdFVwZGF0ZShyZWNvcmRlcik7XG4gICAgfVxuXG4gICAgLy8gVXBkYXRlIGFwcC5zZXJ2ZXIubW9kdWxlIGZpbGVcbiAgICBjb25zdCBhcHBTZXJ2ZXJNb2R1bGUgPSBqb2luKHNvdXJjZVJvb3QsICdhcHAvYXBwLnNlcnZlci5tb2R1bGUudHMnKTtcbiAgICBpZiAodHJlZS5leGlzdHMoYXBwU2VydmVyTW9kdWxlKSkge1xuICAgICAgY29uc3QgcmVjb3JkZXIgPSB0cmVlLmJlZ2luVXBkYXRlKGFwcFNlcnZlck1vZHVsZSk7XG4gICAgICBjb25zdCBhcHBTZXJ2ZXJTb3VyY2VGaWxlID0gY3JlYXRlU291cmNlRmlsZShhcHBTZXJ2ZXJNb2R1bGUpO1xuXG4gICAgICAvLyBSZW1vdmUgaW1wb3J0cyBvZiAnQG5ndW5pdmVyc2FsL21vZHVsZS1tYXAtbmdmYWN0b3J5LWxvYWRlcidcbiAgICAgIGFwcFNlcnZlclNvdXJjZUZpbGVcbiAgICAgICAgLnN0YXRlbWVudHNcbiAgICAgICAgLmZpbHRlcihzID0+IChcbiAgICAgICAgICB0cy5pc0ltcG9ydERlY2xhcmF0aW9uKHMpICYmXG4gICAgICAgICAgcy5tb2R1bGVTcGVjaWZpZXIgJiZcbiAgICAgICAgICB0cy5pc1N0cmluZ0xpdGVyYWwocy5tb2R1bGVTcGVjaWZpZXIpICYmXG4gICAgICAgICAgcy5tb2R1bGVTcGVjaWZpZXIudGV4dCA9PT0gbW9kdWxlTWFwTG9hZGVyUGFja2FnZU5hbWVcbiAgICAgICAgKSlcbiAgICAgICAgLmZvckVhY2gobm9kZSA9PiB7XG4gICAgICAgICAgY29uc3QgaW5kZXggPSBub2RlLmdldEZ1bGxTdGFydCgpO1xuICAgICAgICAgIGNvbnN0IGxlbmd0aCA9IG5vZGUuZ2V0RnVsbFdpZHRoKCk7XG4gICAgICAgICAgcmVjb3JkZXIucmVtb3ZlKGluZGV4LCBsZW5ndGgpO1xuICAgICAgICB9KTtcblxuXG4gICAgICAvLyBDcmVhdGUgYSBUUyBwcmludGVyIHRvIGdldCB0aGUgdGV4dFxuICAgICAgY29uc3QgcHJpbnRlciA9IHRzLmNyZWF0ZVByaW50ZXIoKTtcblxuICAgICAgLy8gUmVtb3ZlICdNb2R1bGVNYXBMb2FkZXJNb2R1bGUnIGZyb20gJ05nTW9kdWxlJyBpbXBvcnRzXG4gICAgICBnZXREZWNvcmF0b3JNZXRhZGF0YShhcHBTZXJ2ZXJTb3VyY2VGaWxlLCAnTmdNb2R1bGUnLCAnQGFuZ3VsYXIvY29yZScpXG4gICAgICAgIC5mb3JFYWNoKChtZXRhZGF0YTogdHMuT2JqZWN0TGl0ZXJhbEV4cHJlc3Npb24pID0+IHtcbiAgICAgICAgICBjb25zdCBtYXRjaGluZ1Byb3BlcnRpZXMgPSBnZXRNZXRhZGF0YUZpZWxkKG1ldGFkYXRhLCAnaW1wb3J0cycpO1xuXG4gICAgICAgICAgaWYgKCFtYXRjaGluZ1Byb3BlcnRpZXMpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBjb25zdCBhc3NpZ25tZW50ID0gbWF0Y2hpbmdQcm9wZXJ0aWVzWzBdIGFzIHRzLlByb3BlcnR5QXNzaWdubWVudDtcbiAgICAgICAgICBpZiAoIXRzLmlzQXJyYXlMaXRlcmFsRXhwcmVzc2lvbihhc3NpZ25tZW50LmluaXRpYWxpemVyKSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGNvbnN0IGFycmF5TGl0ZXJhbCA9IGFzc2lnbm1lbnQuaW5pdGlhbGl6ZXI7XG4gICAgICAgICAgY29uc3QgbmV3SW1wb3J0cyA9IGFycmF5TGl0ZXJhbC5lbGVtZW50c1xuICAgICAgICAgICAgLmZpbHRlcihuID0+ICEodHMuaXNJZGVudGlmaWVyKG4pICYmIG4udGV4dCA9PT0gJ01vZHVsZU1hcExvYWRlck1vZHVsZScpKTtcblxuICAgICAgICAgIGlmIChhcnJheUxpdGVyYWwuZWxlbWVudHMubGVuZ3RoICE9PSBuZXdJbXBvcnRzLmxlbmd0aCkge1xuICAgICAgICAgICAgY29uc3QgbmV3SW1wb3J0c1RleHQgPSBwcmludGVyLnByaW50Tm9kZShcbiAgICAgICAgICAgICAgdHMuRW1pdEhpbnQuVW5zcGVjaWZpZWQsXG4gICAgICAgICAgICAgIHRzLnVwZGF0ZUFycmF5TGl0ZXJhbChhcnJheUxpdGVyYWwsIG5ld0ltcG9ydHMpLFxuICAgICAgICAgICAgICBhcHBTZXJ2ZXJTb3VyY2VGaWxlLFxuICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgY29uc3QgaW5kZXggPSBhcnJheUxpdGVyYWwuZ2V0U3RhcnQoKTtcbiAgICAgICAgICAgIGNvbnN0IGxlbmd0aCA9IGFycmF5TGl0ZXJhbC5nZXRXaWR0aCgpO1xuXG4gICAgICAgICAgICByZWNvcmRlclxuICAgICAgICAgICAgICAucmVtb3ZlKGluZGV4LCBsZW5ndGgpXG4gICAgICAgICAgICAgIC5pbnNlcnRMZWZ0KGluZGV4LCBuZXdJbXBvcnRzVGV4dCk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgdHJlZS5jb21taXRVcGRhdGUocmVjb3JkZXIpO1xuICAgIH1cblxuICAgIC8vIFJlbW92ZSBwYWNrYWdlIGRlcGVuZGVuY3lcbiAgICByZW1vdmVQYWNrYWdlSnNvbkRlcGVuZGVuY3kodHJlZSwgbW9kdWxlTWFwTG9hZGVyUGFja2FnZU5hbWUpO1xuICB9O1xufVxuIl19